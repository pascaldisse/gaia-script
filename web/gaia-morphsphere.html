<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MorphSphere - GaiaScript AI Game</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div id="ui-container">
            <div id="stats-panel">
                <h3>World Stats</h3>
                <div class="stat-row">
                    <span>Morphs: <span id="morph-count">0</span></span>
                    <span>Perception: <span id="perception-level">1</span></span>
                </div>
                <div class="stat-bar-container">
                    <label>Health</label>
                    <div class="stat-bar">
                        <div class="stat-bar-fill health" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat-bar-container">
                    <label>Energy</label>
                    <div class="stat-bar">
                        <div class="stat-bar-fill energy" style="width: 80%"></div>
                    </div>
                </div>
            </div>
            
            <div id="morph-info" class="panel">
                <h3 class="morph-name">Select a Morph</h3>
                <div class="morph-details">
                    <div class="detail-row">
                        <span>Personality: <span id="morph-personality">-</span></span>
                        <span>Ability: <span id="morph-ability">-</span></span>
                    </div>
                    <div class="detail-row">
                        <span>Evolution: <span id="morph-stage">0/3</span></span>
                    </div>
                    <div class="stat-bar-container">
                        <label>Hunger</label>
                        <div class="stat-bar">
                            <div id="morph-hunger-bar" class="stat-bar-fill" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="stat-bar-container">
                        <label>Happiness</label>
                        <div class="stat-bar">
                            <div id="morph-happiness-bar" class="stat-bar-fill" style="width: 50%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="actions-panel" class="panel">
                <h3>Actions</h3>
                <div class="action-buttons">
                    <button id="feed-btn" disabled>Feed</button>
                    <button id="pet-btn" disabled>Pet</button>
                    <button id="play-btn" disabled>Play</button>
                    <button id="speak-btn" disabled>Speak</button>
                    <button id="heal-btn" disabled>Heal</button>
                    <button id="ability-btn" disabled>Use Ability</button>
                    <button id="merge-btn" disabled>Merge</button>
                    <button id="attack-btn" disabled>Attack</button>
                    <button id="create-btn">Create New</button>
                </div>
            </div>
            
            <div id="console-panel" class="panel">
                <h3>Console</h3>
                <div id="console"></div>
            </div>
            
            <div id="gaia-panel" class="panel">
                <h3>GaiaScript</h3>
                <textarea id="gaia-code" placeholder="Enter GaiaScript code...">N M → [A 8 H]×2 → P</textarea>
                <button id="run-btn">Run</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch GaiaScript models
            const gameModel = await fetchGaiaScript('/examples/morphsphere.gaia');
            const morphModel = await fetchGaiaScript('/examples/morphs.gaia');
            const worldModel = await fetchGaiaScript('/examples/world.gaia');
            
            // Initialize GaiaScript runtime
            const runtime = new GaiaRuntime();
            runtime.loadModel(gameModel);
            runtime.loadModel(morphModel);
            runtime.loadModel(worldModel);
            
            // Initialize game
            const game = new MorphSphereGame(runtime);
            window.game = game; // For debugging
        });
        
        // GaiaScript runtime class (minimal implementation)
        class GaiaRuntime {
            constructor() {
                this.models = {};
                this.consoleEl = document.getElementById('console');
            }
            
            loadModel(modelDef) {
                try {
                    // In a real implementation, this would parse and compile the GaiaScript
                    // For now, we'll just store the model definition
                    const id = this.extractModelId(modelDef);
                    this.models[id] = modelDef;
                    this.log(`Model ${id} loaded`, 'system');
                    return true;
                } catch (err) {
                    this.log(`Error loading model: ${err.message}`, 'error');
                    return false;
                }
            }
            
            extractModelId(modelDef) {
                // Simple extraction of the first component ID
                const match = modelDef.match(/N〈([^⊕]+)/);
                return match ? match[1] : 'unknown';
            }
            
            log(message, type = '') {
                const entry = document.createElement('div');
                entry.className = `console-entry ${type}`;
                entry.textContent = message;
                this.consoleEl.appendChild(entry);
                this.consoleEl.scrollTop = this.consoleEl.scrollHeight;
                
                while (this.consoleEl.children.length > 15) {
                    this.consoleEl.removeChild(this.consoleEl.firstChild);
                }
            }
        }
        
        // Fetch GaiaScript code from server
        async function fetchGaiaScript(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.status}`);
                }
                return await response.text();
            } catch (err) {
                console.error('Error fetching GaiaScript:', err);
                return '';
            }
        }
        
        // MorphSphereGame class (simplified implementation that would normally be generated)
        class MorphSphereGame {
            constructor(runtime) {
                this.runtime = runtime;
                this.container = document.getElementById('game-container');
                this.canvas = document.getElementById('game-canvas');
                
                // Initialize UI elements
                this.initUIElements();
                
                // Initialize Three.js components
                this.initScene();
                this.initWorld();
                this.initMorphs(8); // Initial morphs
                
                // Set up controls and event listeners
                this.setupControls();
                
                // Start game loop
                this.animate(0);
                
                // Add initial console messages
                this.log("Welcome to MorphSphere, a surreal pet simulator powered by GaiaScript");
                this.log("Click on a Morph to select it, then use the buttons to interact", "system");
            }
            
            // Other methods would be implemented here, following the same structure
            // as the original JS implementation but generated from GaiaScript

            initUIElements() {
                // UI Elements
                this.statsElements = {
                    morphCount: document.getElementById('morph-count'),
                    perceptionLevel: document.getElementById('perception-level'),
                    healthBar: document.querySelector('.stat-bar-fill.health'),
                    energyBar: document.querySelector('.stat-bar-fill.energy')
                };
                
                this.morphInfo = {
                    container: document.getElementById('morph-info'),
                    name: document.querySelector('.morph-name'),
                    personality: document.getElementById('morph-personality'),
                    ability: document.getElementById('morph-ability'),
                    stage: document.getElementById('morph-stage'),
                    hungerBar: document.getElementById('morph-hunger-bar'),
                    happinessBar: document.getElementById('morph-happiness-bar')
                };
                
                this.console = document.getElementById('console');
                this.gaiaCode = document.getElementById('gaia-code');
                
                // Action buttons
                this.buttons = {
                    feed: document.getElementById('feed-btn'),
                    pet: document.getElementById('pet-btn'),
                    play: document.getElementById('play-btn'),
                    speak: document.getElementById('speak-btn'),
                    heal: document.getElementById('heal-btn'),
                    ability: document.getElementById('ability-btn'),
                    merge: document.getElementById('merge-btn'),
                    create: document.getElementById('create-btn'),
                    attack: document.getElementById('attack-btn'),
                    run: document.getElementById('run-btn')
                };
            }

            initScene() {
                // Initialize scene (simplified implementation)
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x050520);
                this.scene.fog = new THREE.FogExp2(0x050520, 0.02);
                
                this.camera = new THREE.PerspectiveCamera(
                    85,
                    this.container.clientWidth / this.container.clientHeight,
                    0.1,
                    1000
                );
                this.camera.position.set(0, 0, 15);
                
                this.renderer = new THREE.WebGLRenderer({
                    canvas: this.canvas,
                    antialias: true
                });
                this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                this.renderer.shadowMap.enabled = true;
                
                // Set up orbit controls
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                
                // Add lights
                const ambientLight = new THREE.AmbientLight(0x111122, 0.4);
                this.scene.add(ambientLight);
                
                const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
                mainLight.position.set(10, 20, 10);
                mainLight.castShadow = true;
                this.scene.add(mainLight);
                
                // Handle resize
                window.addEventListener('resize', () => this.onWindowResize());
            }
            
            log(message, type = "") {
                this.runtime.log(message, type);
            }

            initWorld() {
                // Create simple terrain
                const geometry = new THREE.PlaneGeometry(100, 100, 50, 50);
                const material = new THREE.MeshStandardMaterial({
                    color: 0x1a1a2e,
                    roughness: 0.8,
                    metalness: 0.2,
                    wireframe: true
                });
                
                this.terrain = new THREE.Mesh(geometry, material);
                this.terrain.rotation.x = -Math.PI / 2;
                this.terrain.position.y = -5;
                this.scene.add(this.terrain);
            }
            
            initMorphs(count) {
                this.morphs = [];
                
                for (let i = 0; i < count; i++) {
                    this.createMorph();
                }
                
                this.updateStatsDisplay();
            }
            
            createMorph() {
                // Create a basic sphere as a morph
                const geometry = new THREE.SphereGeometry(0.5 + Math.random() * 0.5, 32, 32);
                const material = new THREE.MeshStandardMaterial({
                    color: new THREE.Color().setHSL(Math.random(), 0.7, 0.5),
                    roughness: 0.4,
                    metalness: 0.6
                });
                
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(
                    (Math.random() - 0.5) * 20,
                    0.5 + Math.random() * 2,
                    (Math.random() - 0.5) * 20
                );
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                this.scene.add(mesh);
                
                const morph = {
                    mesh: mesh,
                    name: `Morph-${Math.floor(Math.random() * 1000)}`,
                    personality: ["Curious", "Shy", "Aggressive", "Friendly"][Math.floor(Math.random() * 4)],
                    ability: ["Glow", "Teleport", "Morph", "Harmonize"][Math.floor(Math.random() * 4)],
                    stage: 1,
                    hunger: 50 + Math.random() * 20,
                    happiness: 50 + Math.random() * 20
                };
                
                mesh.userData.morph = morph;
                this.morphs.push(morph);
                
                this.log(`${morph.name} has appeared!`, "system");
                return morph;
            }
            
            setupControls() {
                // Button event listeners
                this.buttons.create.addEventListener('click', () => this.createMorph());
                
                // Set up raycasting for morph selection
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                
                // Canvas click for selecting morphs
                this.canvas.addEventListener('click', (event) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.mouse.x = ((event.clientX - rect.left) / this.canvas.clientWidth) * 2 - 1;
                    this.mouse.y = -((event.clientY - rect.top) / this.canvas.clientHeight) * 2 + 1;
                    
                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    
                    const morphMeshes = this.morphs.map(morph => morph.mesh);
                    const intersects = this.raycaster.intersectObjects(morphMeshes);
                    
                    if (intersects.length > 0) {
                        const morph = intersects[0].object.userData.morph;
                        this.selectMorph(morph);
                    }
                });
            }
            
            selectMorph(morph) {
                // Update UI with morph info
                this.morphInfo.name.textContent = morph.name;
                this.morphInfo.personality.textContent = morph.personality;
                this.morphInfo.ability.textContent = morph.ability;
                this.morphInfo.stage.textContent = `${morph.stage}/3`;
                this.morphInfo.hungerBar.style.width = `${morph.hunger}%`;
                this.morphInfo.happinessBar.style.width = `${morph.happiness}%`;
                
                // Show the morph info panel
                this.morphInfo.container.classList.add('visible');
                
                // Enable buttons
                this.buttons.feed.disabled = false;
                this.buttons.pet.disabled = false;
                this.buttons.play.disabled = false;
                this.buttons.speak.disabled = false;
                this.buttons.attack.disabled = false;
                
                this.log(`${morph.name} selected. A ${morph.personality} morph with ${morph.ability} ability.`);
            }
            
            onWindowResize() {
                this.camera.aspect = this.container.clientWidth / this.container.clientHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
            }
            
            updateStatsDisplay() {
                this.statsElements.morphCount.textContent = this.morphs.length;
                this.statsElements.healthBar.style.width = "100%";
                this.statsElements.energyBar.style.width = "80%";
            }
            
            animate(time) {
                requestAnimationFrame((t) => this.animate(t));
                
                // Update controls
                this.controls.update();
                
                // Animate morphs
                this.morphs.forEach(morph => {
                    morph.mesh.rotation.y += 0.01;
                    morph.mesh.position.y = 0.5 + Math.sin(time * 0.001 + Math.random()) * 0.1;
                });
                
                // Render
                this.renderer.render(this.scene, this.camera);
            }
        }
    </script>
</body>
</html>